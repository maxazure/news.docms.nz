<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘æŠ€æ–°é—» - news.docms.nz</title>
    <meta name="description" content="ç§‘æŠ€æ–°é—»å¹³å° - æä¾›æœ€æ–°çš„æŠ€æœ¯èµ„è®¯ã€äº§å“åˆ†æå’Œè¡Œä¸šæŠ¥å‘Š">
    <meta name="keywords" content="ç§‘æŠ€æ–°é—»,æŠ€æœ¯èµ„è®¯,äº§å“åˆ†æ,è¡Œä¸šæŠ¥å‘Š,AI,äººå·¥æ™ºèƒ½,äº’è”ç½‘">
    <meta name="author" content="news.docms.nz">
    <meta name="robots" content="index, follow">
    <meta name="canonical" href="https://news.docms.nz">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://news.docms.nz">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:site_name" content="news.docms.nz">
    <meta property="og:title" :content="currentPage === 'article' && article ? article.title + ' - news.docms.nz' : 'ç§‘æŠ€æ–°é—» - news.docms.nz'">
    <meta property="og:description" :content="currentPage === 'article' && article ? (article.excerpt || article.title) : 'ç§‘æŠ€æ–°é—»å¹³å° - æä¾›æœ€æ–°çš„æŠ€æœ¯èµ„è®¯ã€äº§å“åˆ†æå’Œè¡Œä¸šæŠ¥å‘Š'">
    <meta property="og:image" content="https://news.docms.nz/static/images/og-default.svg">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@newsdocmsnz">
    <meta name="twitter:title" :content="currentPage === 'article' && article ? article.title + ' - news.docms.nz' : 'ç§‘æŠ€æ–°é—» - news.docms.nz'">
    <meta name="twitter:description" :content="currentPage === 'article' && article ? (article.excerpt || article.title) : 'ç§‘æŠ€æ–°é—»å¹³å° - æä¾›æœ€æ–°çš„æŠ€æœ¯èµ„è®¯ã€äº§å“åˆ†æå’Œè¡Œä¸šæŠ¥å‘Š'">
    <meta name="twitter:image" content="https://news.docms.nz/static/images/og-default.svg">

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json" id="schema-org">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "news.docms.nz",
        "url": "https://news.docms.nz",
        "description": "ç§‘æŠ€æ–°é—»å¹³å° - æä¾›æœ€æ–°çš„æŠ€æœ¯èµ„è®¯ã€äº§å“åˆ†æå’Œè¡Œä¸šæŠ¥å‘Š",
        "potentialAction": {
            "@type": "SearchAction",
            "target": {
                "@type": "EntryPoint",
                "urlTemplate": "https://news.docms.nz/?search={search_term_string}"
            },
            "query-input": "required name=search_term_string"
        }
    }
    </script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“°</text></svg>">
    <!-- Google Fonts: Newsreader (serif for headings) + Roboto (sans for body) + Noto Sans SC (Chinese) - optimized for reading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,400&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
{% raw %}
<!-- è·³è½¬åˆ°å†…å®¹é“¾æ¥ï¼ˆé”®ç›˜å¯¼èˆªï¼‰ -->
<a href="#main-content" class="skip-link">è·³è½¬åˆ°ä¸»è¦å†…å®¹</a>

<div id="app">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- é˜…è¯»è¿›åº¦æ¡ -->
    <div class="reading-progress" :style="{ width: readingProgress + '%' }" v-if="currentPage === 'article'"></div>

    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div class="toast-container">
        <div v-for="toast in toasts" :key="toast.id" class="toast" :class="toast.type">
            <div class="toast-content">
                <div class="toast-title">[[toast.title]]</div>
                <div class="toast-message">[[toast.message]]</div>
            </div>
            <button @click="removeToast(toast.id)" class="toast-close">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <a href="/" class="logo">
                <span class="logo-icon"></span>
                ç§‘æŠ€æ–°é—»
            </a>
            <button class="mobile-menu-toggle" @click="mobileMenuOpen = !mobileMenuOpen">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav class="nav" :class="{ 'mobile-open': mobileMenuOpen }">
                <a href="/">é¦–é¡µ</a>
                <template v-if="isLoggedIn">
                    <a href="/admin" v-if="isAdmin">ç®¡ç†åå°</a>
                    <a href="/profile">ä¸ªäººä¸­å¿ƒ</a>
                    <span class="username">[[user?.username || '']]</span>
                    <a href="#" @click.prevent="logout">é€€å‡º</a>
                </template>
                <template v-else>
                    <a href="/login">ç™»å½•</a>
                    <a href="/register">æ³¨å†Œ</a>
                </template>
            </nav>
            <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
            <button class="theme-toggle" @click="toggleTheme" :aria-label="isDarkMode ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼'" :title="isDarkMode ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼'">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
                <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>
    </header>

    <main class="main" id="main-content" role="main" aria-label="ä¸»è¦å†…å®¹åŒºåŸŸ">
        <div class="container">
            <!-- é¦–é¡µ - æ–‡ç« åˆ—è¡¨ -->
            <div class="home-page" v-if="currentPage === 'home'">
                <!-- Hero åŒºåŸŸ -->
                <div class="hero-section">
                    <h1>ç§‘æŠ€æ–°é—»åˆ†äº«å¹³å°</h1>
                    <p>æ¢ç´¢æœ€æ–°çš„æŠ€æœ¯èµ„è®¯ã€äº§å“åˆ†æå’Œè¡Œä¸šè¶‹åŠ¿</p>
                    <div class="hero-stats">
                        <div class="hero-stat">
                            <div class="hero-stat-value">[[stats.total_articles || 0]]</div>
                            <div class="hero-stat-label">ç¯‡æ–‡ç« </div>
                        </div>
                        <div class="hero-stat">
                            <div class="hero-stat-value">[[categories.length || 0]]</div>
                            <div class="hero-stat-label">ä¸ªåˆ†ç±»</div>
                        </div>
                        <div class="hero-stat">
                            <div class="hero-stat-value">[[stats.total_users || 0]]</div>
                            <div class="hero-stat-label">ä½ç”¨æˆ·</div>
                        </div>
                    </div>
                </div>

                <!-- æœç´¢æ¡† -->
                <div class="search-box" style="position: relative;">
                    <input type="text" id="search-input" name="search" v-model="searchQuery" @input="handleSearchInput"
                           @keyup.enter="handleSearch" @focus="showSearchSuggestions = true"
                           placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..." class="search-input" autocomplete="off">
                    <button @click="handleSearch" class="search-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                    </button>
                    <button v-if="searchQuery" @click="clearSearch" class="clear-btn" title="æ¸…é™¤æœç´¢">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                    <!-- æœç´¢å»ºè®® -->
                    <div class="search-suggestions" v-if="showSearchSuggestions && searchSuggestions.length > 0">
                        <div v-for="suggestion in searchSuggestions" :key="suggestion.slug"
                             class="suggestion-item" @click="selectSuggestion(suggestion)">
                            <div class="suggestion-title">[[suggestion.title]]</div>
                            <div class="suggestion-meta">[[suggestion.category_name]] Â· [[formatDate(suggestion.published_at)]]</div>
                        </div>
                    </div>
                </div>

                <!-- é˜…è¯»å†å² -->
                <div class="reading-history" v-if="readingHistory && readingHistory.length > 0">
                    <div class="section-header">
                        <h3>æœ€è¿‘é˜…è¯»</h3>
                        <button @click="clearHistory" class="btn btn-small btn-secondary">æ¸…é™¤</button>
                    </div>
                    <div class="history-list">
                        <a v-for="item in readingHistory.slice(0, 5)" :key="item.slug"
                           :href="'/article/' + item.slug" class="history-item">
                            <span class="history-category" v-if="item.category">[[item.category]]</span>
                            <span class="history-title">[[item.title]]</span>
                        </a>
                    </div>
                </div>

                <!-- æˆ‘çš„æ”¶è— -->
                <div class="bookmarks-section" v-if="bookmarks && bookmarks.length > 0">
                    <div class="section-header">
                        <h3>æˆ‘çš„æ”¶è—</h3>
                        <button @click="clearBookmarks" class="btn btn-small btn-secondary">æ¸…é™¤</button>
                    </div>
                    <div class="bookmark-list">
                        <a v-for="item in bookmarks.slice(0, 5)" :key="item.slug"
                           :href="'/article/' + item.slug" class="bookmark-item">
                            <span class="bookmark-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                </svg>
                            </span>
                            <span class="bookmark-title">[[item.title]]</span>
                            <span class="bookmark-date">[[formatDate(item.bookmarked_at)]]</span>
                        </a>
                    </div>
                </div>

                <!-- çƒ­é—¨æ–‡ç«  -->
                <div class="popular-articles" v-if="popularArticles && popularArticles.length > 0">
                    <div class="section-header">
                        <h3>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 6l-9.5 9.5-5-5L1 18"/>
                                <path d="M17 6h6v6"/>
                            </svg>
                            çƒ­é—¨æ–‡ç« 
                        </h3>
                    </div>
                    <div class="popular-list">
                        <a v-for="(article, index) in popularArticles" :key="article.id"
                           :href="'/article/' + article.slug" class="popular-item">
                            <span class="popular-rank" :class="'rank-' + (index + 1)">[[index + 1]]</span>
                            <div class="popular-content">
                                <span class="popular-title">[[article.title]]</span>
                                <span class="popular-meta">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                                    </svg>
                                    [[article.view_count]] é˜…è¯»
                                </span>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- åˆ†ç±»ç­›é€‰ -->
                <div class="category-filter" v-if="categories.length > 0">
                    <button @click="filterByCategory(null)" :class="{ active: !selectedCategory }" class="category-btn">å…¨éƒ¨</button>
                    <button v-for="cat in categories" :key="cat.id" @click="filterByCategory(cat.id)"
                            :class="{ active: selectedCategory === cat.id }" class="category-btn">
                        [[cat.name]]
                    </button>
                </div>

                <!-- åˆ†ç±»ç£è´´ -->
                <div class="category-tiles" v-if="categories.length > 0">
                    <div class="category-tile fade-in-section" :class="{ active: !selectedCategory }" @click="filterByCategory(null)">
                        <div class="category-tile-icon">ğŸ“š</div>
                        <div class="category-tile-name">å…¨éƒ¨</div>
                    </div>
                    <div v-for="(cat, index) in categories" :key="cat.id" class="category-tile fade-in-section"
                         :class="{ active: selectedCategory === cat.id }" @click="filterByCategory(cat.id)"
                         :style="{ transitionDelay: (index + 1) * 50 + 'ms' }">
                        <div class="category-tile-icon">ğŸ“</div>
                        <div class="category-tile-name">[[cat.name]]</div>
                    </div>
                </div>

                <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
                <div class="article-list" v-if="loading && (!articles || articles.length === 0)">
                    <div class="skeleton-card skeleton" v-for="n in 5" :key="n">
                        <div class="skeleton-category skeleton"></div>
                        <div class="skeleton-title skeleton"></div>
                        <div class="skeleton-excerpt skeleton"></div>
                        <div class="skeleton-excerpt skeleton"></div>
                        <div class="skeleton-meta skeleton"></div>
                    </div>
                </div>

                <!-- æ–‡ç« åˆ—è¡¨ -->
                <div class="article-list" v-if="articles && articles.length > 0">
                    <article class="article-card fade-in-section" v-for="(article, index) in articles" :key="article.id" :style="{ transitionDelay: (index % 10) * 50 + 'ms' }">
                        <div class="article-card-header">
                            <span v-if="article.category_name" class="category-tag" :class="article.category_name.toLowerCase().replace(/\s+/g, '-')">[[article.category_name]]</span>
                            <div class="article-meta">
                                <span v-if="article.author_name" class="author">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                    [[article.author_name]]
                                </span>
                                <span class="article-date">[[formatDate(article.published_at)]]</span>
                                <span class="read-time">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                    </svg>
                                    [[calculateReadTime(article.content)]]
                                </span>
                            </div>
                        </div>
                        <h2><a :href="'/article/' + article.slug">[[article.title]]</a></h2>
                        <p class="article-excerpt">[[article.excerpt]]</p>
                        <div class="article-tags" v-if="article.tags && article.tags.length > 0">
                            <span v-for="tag in article.tags.split(',').slice(0, 3)" :key="tag" class="tag">[[tag.trim()]]</span>
                        </div>
                        <div class="article-meta" style="margin-top: 12px;">
                            <span class="views">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                [[article.view_count]] é˜…è¯»
                            </span>
                            <button @click.prevent="toggleBookmark(article)" class="bookmark-btn" :class="{ active: isBookmarked(article.slug) }" :title="isBookmarked(article.slug) ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—æ–‡ç« '">
                                <svg width="16" height="16" viewBox="0 0 24 24" :fill="isBookmarked(article.slug) ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                </svg>
                            </button>
                        </div>
                        <a :href="'/article/' + article.slug" class="btn btn-primary btn-small">é˜…è¯»å…¨æ–‡</a>
                    </article>
                </div>
                <div v-else class="no-articles">
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        <p v-if="searchQuery">æ²¡æœ‰æ‰¾åˆ°ä¸ã€Œ[[searchQuery]]ã€ç›¸å…³çš„æ–‡ç« </p>
                        <p v-else>æš‚æ— æ–‡ç« </p>
                        <button v-if="searchQuery" @click="clearSearch" class="btn btn-secondary">æ¸…é™¤æœç´¢</button>
                    </div>
                </div>

                <!-- åˆ†é¡µ -->
                <div class="pagination" v-if="totalPages > 1">
                    <a v-if="currentPageNum > 1" href="#" @click.prevent="goToPage(currentPageNum - 1)">ä¸Šä¸€é¡µ</a>
                    <span v-for="page in Math.min(5, totalPages)" :key="page"
                          :class="{ active: page === currentPageNum }"
                          @click.prevent="goToPage(page)">
                        [[page]]
                    </span>
                    <span v-if="totalPages > 5">...</span>
                    <a v-if="currentPageNum < totalPages" href="#" @click.prevent="goToPage(currentPageNum + 1)">ä¸‹ä¸€é¡µ</a>
                </div>
            </div>

            <!-- æ–‡ç« è¯¦æƒ…é¡µ -->
            <div class="article-detail-page" v-else-if="currentPage === 'article'">
                <div v-if="article" class="article-detail">
                    <div class="article-header">
                        <span v-if="article.category_name" class="category-tag large">[[article.category_name]]</span>
                        <h1>[[article.title]]</h1>
                        <div class="article-meta-full">
                            <span v-if="article.author_name" class="author">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                                [[article.author_name]]
                            </span>
                            <span class="date">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                </svg>
                                [[formatFullDate(article.published_at)]]
                            </span>
                            <span class="read-time">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                </svg>
                                <span class="read-time-text">[[calculateReadTime(article.content)]]</span>
                            </span>
                            <span class="views">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                [[article.view_count]] é˜…è¯»
                            </span>
                        </div>
                        <!-- æ ‡ç­¾ -->
                        <div class="article-tags" v-if="article.tags && article.tags.length > 0" style="margin-top: 16px;">
                            <span v-for="tag in article.tags.split(',')" :key="tag" class="tag primary">[[tag.trim()]]</span>
                        </div>
                    </div>

                    <!-- æ–‡ç« ç›®å½• -->
                    <div class="table-of-contents" v-if="tocItems.length > 0">
                        <h3>ç›®å½•</h3>
                        <ul class="toc-list">
                            <li v-for="item in tocItems" :key="item.id">
                                <a :href="'#' + item.id" :class="{ 'toc-h3': item.level === 3, 'active': activeToc === item.id }"
                                   @click.prevent="scrollToHeading(item.id)">[[item.text]]</a>
                            </li>
                        </ul>
                    </div>

                    <div class="article-content" v-html="article.html_content" ref="articleContent"></div>

                    <!-- åˆ†äº«æŒ‰é’® -->
                    <div class="share-buttons">
                        <button class="share-btn" @click="shareArticle('wechat')" title="åˆ†äº«åˆ°å¾®ä¿¡">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8.5 11c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm5 0c.83 0 1.5-.67 1.5-1.5S14.33 8 13.5 8 12 8.67 12 9.5s.67 1.5 1.5 1.5zm4.5 4c0 2.76-2.24 5-5 5H6c-3.31 0-6-2.69-6-6 0-2.05 1.05-3.87 2.62-4.78.45-.26.52-.72.52-1.13 0-.57-.45-1.09-1.04-1.09H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h7c1.1 0 2-.9 2-2v-4.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5V15h2v-4.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5V15h2v-3c0-1.1.9-2 2-2h3v5z"/></svg>
                        </button>
                        <button class="share-btn" @click="shareArticle('weibo')" title="åˆ†äº«åˆ°å¾®åš">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 9.5c-.7 0-1.4.1-2 .3 1.4-1.4 2.1-3.2 1.9-4.8-2.1.1-4.5 1.2-5.9 3-1.1 1.4-1.6 3.1-1.5 4.9.1 1.8 1 3.4 2.5 4.5-.6-.3-1.2-.7-1.8-1.2-.9-.8-1.5-1.8-1.8-3-.3-1.2 0-2.4.7-3.4.6-.9 1.5-1.6 2.5-1.9.4-2.5 2.4-4.4 5-4.4h.7c1.2 0 2.4.5 3.2 1.4.6.7 1 1.6 1 2.5 0 .2 0 .5-.1.7.7-.1 1.4-.2 2-.2zM3.5 15c-.4 0-.8-.1-1.1-.4-.9-.8-1-2.2-.2-3.5.6-1 1.6-1.7 2.7-1.9 1.1-2.5 3.4-4.2 6-4.2 1.2 0 2.4.3 3.4 1 1.2.8 2 2 2.2 3.4.1.6 0 1.2-.2 1.8-.6-1.1-1.5-2-2.6-2.6-.2-.1-.4-.2-.6-.2-1.5.1-2.8 1-3.7 2.2-.8 1.1-1.1 2.4-.8 3.7.4 1.4 1.5 2.6 2.9 3.2-.4-.7-.5-1.5-.3-2.3.2-.8.8-1.5 1.6-1.9.8-.4 1.7-.4 2.5 0 .5.3.9.7 1.1 1.2.3-.5.4-1 .4-1.6 0-1.6-.9-3.1-2.3-3.9-.8-.5-1.8-.7-2.7-.6-1.4.1-2.7.9-3.4 2.1-.6 1-1 2.2-.9 3.4 0 .5.1 1 .4 1.4-1.6.4-2.7 1.7-2.9 3.3-.1.7 0 1.4.4 2z"/></svg>
                        </button>
                        <button class="share-btn" @click="shareArticle('twitter')" title="åˆ†äº«åˆ° Twitter">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        </button>
                        <button class="share-btn" @click="shareArticle('link')" title="å¤åˆ¶é“¾æ¥">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                        </button>
                    </div>

                    <!-- ä½œè€…ä¿¡æ¯ -->
                    <div class="author-bio" v-if="article && article.author_name">
                        <div class="author-avatar">
                            [[article.author_name.charAt(0).toUpperCase()]]
                        </div>
                        <div class="author-info">
                            <div class="author-name">[[article.author_name]]</div>
                            <div class="author-bio-text">
                                <span v-if="article.author_role">[[article.author_role]] Â· </span>
                                <span>ç§‘æŠ€æ–°é—»æ’°ç¨¿äººï¼Œä¸“æ³¨äºæŠ€æœ¯è¶‹åŠ¿å’Œè¡Œä¸šåˆ†æ</span>
                            </div>
                        </div>
                    </div>

                    <!-- ç›¸å…³æ–‡ç«  -->
                    <div class="related-articles" v-if="relatedArticles && relatedArticles.length > 0">
                        <h3>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                                <path d="M12 8v8M8 12h8"/>
                            </svg>
                            ç›¸å…³æ–‡ç« 
                        </h3>
                        <div class="related-list">
                            <a v-for="related in relatedArticles.slice(0, 3)" :key="related.id" :href="'/article/' + related.slug" class="related-item">
                                <div class="related-content">
                                    <span class="related-title">[[related.title]]</span>
                                    <span class="related-meta">
                                        [[formatShortDate(related.published_at)]] Â· [[related.view_count]] é˜…è¯»
                                    </span>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- æ–‡ç« æ“ä½œæ  -->
                    <div class="article-toolbar">
                        <div class="article-nav-links">
                            <a href="/" class="article-nav-link">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                                è¿”å›é¦–é¡µ
                            </a>
                        </div>
                        <button @click="scrollToTop" class="btn btn-secondary btn-small">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
                            å›åˆ°é¡¶éƒ¨
                        </button>
                    </div>
                </div>
                <div v-else class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <!-- ç™»å½•é¡µ -->
            <div class="auth-page" v-else-if="currentPage === 'login'">
                <div class="auth-card">
                    <div class="auth-header">
                        <h1>ç™»å½•</h1>
                        <p>æ¬¢è¿å›æ¥</p>
                    </div>
                    <div v-if="error" class="error-message">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                        [[error]]
                    </div>
                    <div v-if="successMessage" class="success-message">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                        [[successMessage]]
                    </div>
                    <form @submit.prevent="handleLogin">
                        <div class="form-group">
                            <label>ç”¨æˆ·åæˆ–é‚®ç®±</label>
                            <input type="text" id="login-username" name="username" v-model="loginForm.username" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±" required autocomplete="username">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input type="password" id="login-password" name="password" v-model="loginForm.password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç " required autocomplete="current-password">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block" :disabled="submitting">
                            <span v-if="submitting">ç™»å½•ä¸­...</span>
                            <span v-else>ç™»å½•</span>
                        </button>
                    </form>
                    <div class="auth-links">
                        <p>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="/register">ç«‹å³æ³¨å†Œ</a></p>
                        <p><a href="/">è¿”å›é¦–é¡µ</a></p>
                    </div>
                </div>
            </div>

            <!-- æ³¨å†Œé¡µ -->
            <div class="auth-page" v-else-if="currentPage === 'register'">
                <div class="auth-card">
                    <div class="auth-header">
                        <h1>æ³¨å†Œ</h1>
                        <p>åˆ›å»ºæ–°è´¦å·</p>
                    </div>
                    <div v-if="error" class="error-message">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                        [[error]]
                    </div>
                    <div v-if="successMessage" class="success-message">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                        [[successMessage]]
                    </div>
                    <form @submit.prevent="handleRegister">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="register-username" name="username" v-model="registerForm.username" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required autocomplete="username">
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±</label>
                            <input type="email" id="register-email" name="email" v-model="registerForm.email" class="form-control" placeholder="è¯·è¾“å…¥é‚®ç®±" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input type="password" id="register-password" name="password" v-model="registerForm.password" class="form-control" placeholder="è‡³å°‘8ä½å­—ç¬¦" required minlength="8" autocomplete="new-password">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block" :disabled="submitting">
                            <span v-if="submitting">æ³¨å†Œä¸­...</span>
                            <span v-else>æ³¨å†Œ</span>
                        </button>
                    </form>
                    <div class="auth-links">
                        <p>å·²æœ‰è´¦å·ï¼Ÿ<a href="/login">ç«‹å³ç™»å½•</a></p>
                        <p><a href="/">è¿”å›é¦–é¡µ</a></p>
                    </div>
                </div>
            </div>

            <!-- ä¸ªäººä¸­å¿ƒ -->
            <div class="profile-page" v-else-if="currentPage === 'profile'">
                <div class="profile-card" v-if="user">
                    <div class="profile-header">
                        <div class="avatar">[[user.username.charAt(0).toUpperCase()]]</div>
                        <h1>[[user.username]]</h1>
                        <span class="role-badge" :class="user.role">[[user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·']]</span>
                    </div>
                    <div class="profile-info">
                        <div class="info-item">
                            <label>ç”¨æˆ·å</label>
                            <span>[[user.username]]</span>
                        </div>
                        <div class="info-item">
                            <label>é‚®ç®±</label>
                            <span>[[user.email]]</span>
                        </div>
                        <div class="info-item">
                            <label>è§’è‰²</label>
                            <span>[[user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·']]</span>
                        </div>
                        <div class="info-item">
                            <label>æ³¨å†Œæ—¶é—´</label>
                            <span>[[formatFullDate(user.created_at)]]</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button @click="logout" class="btn btn-danger">é€€å‡ºç™»å½•</button>
                        <a href="/" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†åå° -->
            <div class="admin-page" v-else-if="currentPage === 'admin'">
                <div class="admin-layout">
                    <!-- ä¾§è¾¹æ  -->
                    <aside class="admin-sidebar">
                        <div class="sidebar-header">
                            <h2>ç®¡ç†åå°</h2>
                        </div>
                        <nav class="sidebar-nav">
                            <a @click="adminSection = 'dashboard'" :class="{ active: adminSection === 'dashboard' }">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                                ä»ªè¡¨ç›˜
                            </a>
                            <a @click="adminSection = 'articles'" :class="{ active: adminSection === 'articles' }">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                                æ–‡ç« ç®¡ç†
                            </a>
                            <a @click="adminSection = 'categories'" :class="{ active: adminSection === 'categories' }">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                                åˆ†ç±»ç®¡ç†
                            </a>
                            <a @click="adminSection = 'users'" :class="{ active: adminSection === 'users' }">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                ç”¨æˆ·ç®¡ç†
                            </a>
                        </nav>
                    </aside>

                    <!-- ä¸»å†…å®¹åŒº -->
                    <main class="admin-content">
                        <!-- ä»ªè¡¨ç›˜ -->
                        <div v-if="adminSection === 'dashboard'" class="admin-section">
                            <h1>ä»ªè¡¨ç›˜</h1>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon blue">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-value">[[stats.total_articles]]</span>
                                        <span class="stat-label">æ–‡ç« æ€»æ•°</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon green">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-value">[[stats.published_articles]]</span>
                                        <span class="stat-label">å·²å‘å¸ƒ</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon orange">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-value">[[stats.draft_articles]]</span>
                                        <span class="stat-label">è‰ç¨¿</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon purple">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-value">[[stats.total_users]]</span>
                                        <span class="stat-label">ç”¨æˆ·æ•°</span>
                                    </div>
                                </div>
                            </div>
                            <div class="recent-articles">
                                <h2>æœ€æ–°æ–‡ç« </h2>
                                <div class="article-list-simple" v-if="recentArticles.length > 0">
                                    <div v-for="article in recentArticles" :key="article.id" class="article-item-simple">
                                        <span class="article-title">[[article.title]]</span>
                                        <span class="article-status" :class="article.status">[[article.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿']]</span>
                                        <span class="article-date">[[formatFullDate(article.created_at)]]</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ–‡ç« ç®¡ç† -->
                        <div v-else-if="adminSection === 'articles'" class="admin-section">
                            <div class="section-header">
                                <h1>æ–‡ç« ç®¡ç†</h1>
                                <button @click="showEditor = true; editingArticle = null" class="btn btn-primary">æ–°å»ºæ–‡ç« </button>
                            </div>
                            <div class="article-table">
                                <div class="table-header">
                                    <span>æ ‡é¢˜</span>
                                    <span>åˆ†ç±»</span>
                                    <span>çŠ¶æ€</span>
                                    <span>é˜…è¯»</span>
                                    <span>å‘å¸ƒæ—¶é—´</span>
                                    <span>æ“ä½œ</span>
                                </div>
                                <div v-if="allArticles.length > 0" class="table-body">
                                    <div v-for="article in allArticles" :key="article.id" class="table-row">
                                        <span class="title-cell">[[article.title]]</span>
                                        <span>[[article.category_name || '-']]</span>
                                        <span>
                                            <span class="status-badge" :class="article.status">
                                                [[article.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿']]
                                            </span>
                                        </span>
                                        <span>[[article.view_count]]</span>
                                        <span>[[formatShortDate(article.published_at)]]</span>
                                        <span class="actions">
                                            <button @click="editArticle(article)" class="btn-icon" title="ç¼–è¾‘">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                            </button>
                                            <button v-if="article.status === 'draft'" @click="publishArticle(article)" class="btn-icon" title="å‘å¸ƒ">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                            </button>
                                            <button v-else @click="unpublishArticle(article)" class="btn-icon" title="ä¸‹æ¶">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                            </button>
                                            <button @click="deleteArticle(article)" class="btn-icon danger" title="åˆ é™¤">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                            </button>
                                        </span>
                                    </div>
                                </div>
                                <div v-else class="table-empty">
                                    <p>æš‚æ— æ–‡ç« </p>
                                </div>
                            </div>
                        </div>

                        <!-- åˆ†ç±»ç®¡ç† -->
                        <div v-else-if="adminSection === 'categories'" class="admin-section">
                            <div class="section-header">
                                <h1>åˆ†ç±»ç®¡ç†</h1>
                                <button @click="showCategoryForm = true" class="btn btn-primary">æ–°å»ºåˆ†ç±»</button>
                            </div>
                            <div class="category-list">
                                <div v-for="cat in categories" :key="cat.id" class="category-item">
                                    <div class="category-info">
                                        <span class="category-name">[[cat.name]]</span>
                                        <span class="category-slug">[[cat.slug]]</span>
                                    </div>
                                    <div class="category-actions">
                                        <button @click="editCategory(cat)" class="btn btn-small btn-secondary">ç¼–è¾‘</button>
                                        <button @click="deleteCategory(cat)" class="btn btn-small btn-danger">åˆ é™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç”¨æˆ·ç®¡ç† -->
                        <div v-else-if="adminSection === 'users'" class="admin-section">
                            <div class="section-header">
                                <h1>ç”¨æˆ·ç®¡ç†</h1>
                            </div>
                            <div class="user-table">
                                <div class="table-header">
                                    <span>ç”¨æˆ·å</span>
                                    <span>é‚®ç®±</span>
                                    <span>è§’è‰²</span>
                                    <span>çŠ¶æ€</span>
                                    <span>æ³¨å†Œæ—¶é—´</span>
                                    <span>æ“ä½œ</span>
                                </div>
                                <div v-if="users.length > 0" class="table-body">
                                    <div v-for="userItem in users" :key="userItem.id" class="table-row">
                                        <span>[[userItem.username]]</span>
                                        <span>[[userItem.email]]</span>
                                        <span>
                                            <span class="role-badge" :class="userItem.role">
                                                [[userItem.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·']]
                                            </span>
                                        </span>
                                        <span>
                                            <span class="status-badge" :class="{ active: userItem.is_active }">
                                                [[userItem.is_active ? 'å¯ç”¨' : 'ç¦ç”¨']]
                                            </span>
                                        </span>
                                        <span>[[formatShortDate(userItem.created_at)]]</span>
                                        <span class="actions">
                                            <button v-if="userItem.id !== user.id" @click="toggleUser(userItem)" class="btn btn-small btn-secondary">
                                                [[userItem.is_active ? 'ç¦ç”¨' : 'å¯ç”¨']]
                                            </button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </main>

    <!-- æ–‡ç« ç¼–è¾‘å™¨å¼¹çª— -->
    <div v-if="showEditor" class="modal-overlay" @click.self="showEditor = false">
        <div class="modal-content editor-modal">
            <div class="modal-header">
                <h2>[[editingArticle ? 'ç¼–è¾‘æ–‡ç« ' : 'æ–°å»ºæ–‡ç« ']]</h2>
                <button @click="showEditor = false" class="modal-close">&times;</button>
            </div>
            <form @submit.prevent="saveArticle">
                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" v-model="articleForm.title" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ†ç±»</label>
                        <select v-model="articleForm.category_id" class="form-control">
                            <option :value="null">æ— åˆ†ç±»</option>
                            <option v-for="cat in categories" :key="cat.id" :value="cat.id">[[cat.name]]</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>çŠ¶æ€</label>
                        <select v-model="articleForm.status" class="form-control">
                            <option value="draft">è‰ç¨¿</option>
                            <option value="published">å‘å¸ƒ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        å†…å®¹ (Markdown)
                        <button type="button" @click="showPreview = !showPreview" class="preview-toggle-btn">
                            [[showPreview ? 'éšè—é¢„è§ˆ' : 'æ˜¾ç¤ºé¢„è§ˆ']]
                        </button>
                    </label>
                    <div class="editor-with-preview" :class="{ 'preview-active': showPreview }">
                        <textarea v-model="articleForm.content" class="form-control editor-textarea" rows="15" required placeholder="ä½¿ç”¨ Markdown æ ¼å¼ç¼–å†™..."></textarea>
                        <div v-if="showPreview" class="markdown-preview" v-html="previewHtml"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" @click="showEditor = false" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" :disabled="submitting">
                        [[submitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜']]
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ†ç±»è¡¨å•å¼¹çª— -->
    <div v-if="showCategoryForm" class="modal-overlay" @click.self="showCategoryForm = false">
        <div class="modal-content">
            <div class="modal-header">
                <h2>[[editingCategory ? 'ç¼–è¾‘åˆ†ç±»' : 'æ–°å»ºåˆ†ç±»']]</h2>
                <button @click="showCategoryForm = false" class="modal-close">&times;</button>
            </div>
            <form @submit.prevent="saveCategory">
                <div class="form-group">
                    <label>åˆ†ç±»åç§°</label>
                    <input type="text" v-model="categoryForm.name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Slug</label>
                    <input type="text" v-model="categoryForm.slug" class="form-control">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea v-model="categoryForm.description" class="form-control" rows="2"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" @click="showCategoryForm = false" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
    <nav class="mobile-bottom-nav">
        <a href="/" :class="{ active: currentPage === 'home' }">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            é¦–é¡µ
        </a>
        <a href="#" @click.prevent="scrollToSearch">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            æœç´¢
        </a>
        <template v-if="isLoggedIn">
            <a href="/profile" :class="{ active: currentPage === 'profile' }">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                æˆ‘çš„
            </a>
            <a href="/admin" v-if="isAdmin" :class="{ active: currentPage === 'admin' }">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                ç®¡ç†
            </a>
        </template>
        <template v-else>
            <a href="/login">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                ç™»å½•
            </a>
        </template>
    </nav>

    <!-- æ–°é—»é€šè®¯è®¢é˜… -->
    <div class="newsletter-section" v-if="currentPage === 'home'">
        <div class="newsletter-container">
            <div class="newsletter-content">
                <div class="newsletter-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                </div>
                <div class="newsletter-text">
                    <h3>è®¢é˜…æˆ‘ä»¬çš„æ–°é—»é€šè®¯</h3>
                    <p>è·å–æœ€æ–°çš„æŠ€æœ¯èµ„è®¯å’Œè¡Œä¸šåŠ¨æ€ï¼Œæ¯å‘¨ç²¾é€‰å†…å®¹ç›´æ¥å‘é€åˆ°æ‚¨çš„é‚®ç®±</p>
                </div>
                <form @submit.prevent="subscribeNewsletter" class="newsletter-form">
                    <input type="email" v-model="newsletterEmail" placeholder="è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" class="newsletter-input" required>
                    <button type="submit" class="newsletter-btn" :disabled="newsletterSubmitting">
                        <span v-if="newsletterSubmitting">è®¢é˜…ä¸­...</span>
                        <span v-else>è®¢é˜…</span>
                    </button>
                </form>
            </div>
            <div v-if="newsletterMessage" class="newsletter-message" :class="newsletterMessage.type">
                [[newsletterMessage.text]]
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>å…³äºæˆ‘ä»¬</h4>
                <p>ç§‘æŠ€æ–°é—»åˆ†äº«å¹³å° - æä¾›æœ€æ–°çš„æŠ€æœ¯èµ„è®¯ã€äº§å“åˆ†æå’Œè¡Œä¸šè¶‹åŠ¿</p>
            </div>
            <div class="footer-section">
                <h4>å¿«é€Ÿé“¾æ¥</h4>
                <a href="/">é¦–é¡µ</a>
                <a href="/login">ç™»å½•</a>
                <a href="/register">æ³¨å†Œ</a>
            </div>
            <div class="footer-section">
                <h4>å¿«æ·é”®</h4>
                <span><kbd>/</kbd> æœç´¢</span>
                <span><kbd>Esc</kbd> è¿”å›</span>
                <span><kbd>Home</kbd> é¡¶éƒ¨</span>
                <span><kbd>End</kbd> åº•éƒ¨</span>
            </div>
        </div>
        <p class="footer-copyright">&copy; 2026 news.docms.nz - ç§‘æŠ€æ–°é—»åˆ†äº«å¹³å°</p>
    </footer>
</div>
{% endraw %}

<script src="/static/lib/vue.min.js"></script>
<script src="/static/lib/marked.min.js"></script>
<script>
// Simple auth state management
const authState = Vue.reactive({
    user: JSON.parse(localStorage.getItem('user') || 'null'),
    token: localStorage.getItem('access_token') || null,
    get isLoggedIn() { return !!this.token; },
    get isAdmin() { return this.user?.role === 'admin'; },
    setUser(user, token) {
        this.user = user;
        this.token = token;
        localStorage.setItem('user', JSON.stringify(user));
        localStorage.setItem('access_token', token);
    },
    logout() {
        this.user = null;
        this.token = null;
        localStorage.removeItem('user');
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
    }
});

const api = {
    async request(url, options = {}) {
        const token = localStorage.getItem('access_token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const response = await fetch('/api' + url, { ...options, headers: { ...headers, ...options.headers } });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
        return { data };
    },
    get(url, params = {}) {
        const query = new URLSearchParams(params).toString();
        return this.request(query ? url + '?' + query : url);
    },
    post(url, data) {
        return this.request(url, { method: 'POST', body: JSON.stringify(data) });
    },
    put(url, data) {
        return this.request(url, { method: 'PUT', body: JSON.stringify(data) });
    },
    delete(url) {
        return this.request(url, { method: 'DELETE' });
    }
};

const app = Vue.createApp({
    delimiters: ['[[', ']]'],
    setup() {
        // çŠ¶æ€
        const currentPage = Vue.ref('home');
        const articles = Vue.ref([]);
        const article = Vue.ref(null);
        const categories = Vue.ref([]);
        const allArticles = Vue.ref([]);
        const users = Vue.ref([]);
        const recentArticles = Vue.ref([]);
        const stats = Vue.ref({ total_users: 0, total_articles: 0, published_articles: 0, draft_articles: 0 });
        const totalPages = Vue.ref(1);
        const currentPageNum = Vue.ref(1);
        const selectedCategory = Vue.ref(null);
        const error = Vue.ref('');
        const successMessage = Vue.ref('');
        const loading = Vue.ref(false);
        const submitting = Vue.ref(false);
        const mobileMenuOpen = Vue.ref(false);
        const searchQuery = Vue.ref('');

        // æ–°å¢çŠ¶æ€
        const toasts = Vue.ref([]);
        const readingProgress = Vue.ref(0);
        const searchSuggestions = Vue.ref([]);
        const readingHistory = Vue.ref(getHistory());
        const bookmarks = Vue.ref(getBookmarks());
        const showSearchSuggestions = Vue.ref(false);
        const popularArticles = Vue.ref([]);

        // æ–°é—»é€šè®¯è®¢é˜…
        const newsletterEmail = Vue.ref('');
        const newsletterSubmitting = Vue.ref(false);
        const newsletterMessage = Vue.ref(null);

        // ä¸»é¢˜åˆ‡æ¢
        const isDarkMode = Vue.ref(false);
        const THEME_KEY = 'news_theme';
        const SYSTEM_DARK = window.matchMedia('(prefers-color-scheme: dark)');

        const initTheme = () => {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme) {
                isDarkMode.value = savedTheme === 'dark';
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                isDarkMode.value = SYSTEM_DARK.matches;
                document.documentElement.setAttribute('data-theme', SYSTEM_DARK.matches ? 'dark' : 'light');
            }
        };

        const toggleTheme = () => {
            isDarkMode.value = !isDarkMode.value;
            const theme = isDarkMode.value ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem(THEME_KEY, theme);
        };

        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
        SYSTEM_DARK.addEventListener('change', (e) => {
            if (!localStorage.getItem(THEME_KEY)) {
                isDarkMode.value = e.matches;
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        // åˆå§‹åŒ–ä¸»é¢˜
        initTheme();
        const tocItems = Vue.ref([]);
        const activeToc = Vue.ref('');
        const articleContent = Vue.ref(null);

        // è¡¨å•æ•°æ®
        const loginForm = Vue.ref({ username: '', password: '' });
        const registerForm = Vue.ref({ username: '', email: '', password: '' });
        const articleForm = Vue.ref({ title: '', content: '', category_id: null, status: 'draft' });
        const categoryForm = Vue.ref({ name: '', slug: '', description: '' });

        // ç¼–è¾‘å™¨çŠ¶æ€
        const showEditor = Vue.ref(false);
        const showCategoryForm = Vue.ref(false);
        const editingArticle = Vue.ref(null);
        const editingCategory = Vue.ref(null);
        const adminSection = Vue.ref('dashboard');
        const showPreview = Vue.ref(false);

        // Markdown é¢„è§ˆè®¡ç®—å±æ€§
        const previewHtml = Vue.computed(() => {
            if (!articleForm.value.content) return '<p class="preview-placeholder">é¢„è§ˆå°†åœ¨æ­¤å¤„æ˜¾ç¤º...</p>';
            return marked.parse(articleForm.value.content);
        });

        // è·¯ç”±å¤„ç†
        const handleRouteChange = () => {
            const path = window.location.pathname;
            mobileMenuOpen.value = false;

            if (path === '/' || path.startsWith('/page/')) {
                currentPage.value = 'home';
                const page = path === '/' ? 1 : parseInt(path.split('/')[2]) || 1;
                currentPageNum.value = page;
                fetchArticles(page);
            } else if (path.startsWith('/article/')) {
                currentPage.value = 'article';
                fetchArticle(path.split('/')[2]);
            } else if (path === '/login') {
                currentPage.value = 'login';
            } else if (path === '/register') {
                currentPage.value = 'register';
            } else if (path === '/profile') {
                currentPage.value = 'profile';
            } else if (path === '/admin') {
                if (!authState.isAdmin) {
                    window.location.href = '/login';
                    return;
                }
                currentPage.value = 'admin';
                fetchAdminData();
            }
        };

        const navigateTo = (path) => {
            window.history.pushState({}, '', path);
            handleRouteChange();
        };

        // æ•°æ®è·å–
        const fetchArticles = async (page = 1) => {
            try {
                loading.value = true;
                const params = { page, per_page: 10 };
                if (selectedCategory.value) params.category_id = selectedCategory.value;
                if (searchQuery.value) params.search = searchQuery.value;
                const r = await api.get('/articles', params);
                articles.value = r.data.articles;
                totalPages.value = r.data.pages;
            } catch (e) {
                error.value = e.message;
            } finally {
                loading.value = false;
            }
        };

        const fetchArticle = async (slug) => {
            try {
                loading.value = true;
                const r = await api.get('/articles/' + slug);
                article.value = r.data.article;

                // æ·»åŠ åˆ°é˜…è¯»å†å²
                addToHistory(r.data.article);
            } catch (e) {
                error.value = e.message;
            } finally {
                loading.value = false;
            }
        };

        // é˜…è¯»å†å²ç®¡ç†
        const HISTORY_KEY = 'news_history';
        const MAX_HISTORY = 10;

        const getHistory = () => {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            } catch {
                return [];
            }
        };

        const saveHistory = (history) => {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, MAX_HISTORY)));
        };

        const addToHistory = (article) => {
            if (!article || !article.slug) return;
            const history = getHistory();
            // ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒæ–‡ç« 
            const filtered = history.filter(h => h.slug !== article.slug);
            // æ·»åŠ åˆ°å¼€å¤´
            filtered.unshift({
                slug: article.slug,
                title: article.title,
                category: article.category_name,
                readAt: new Date().toISOString()
            });
            saveHistory(filtered);
        };

        const clearHistory = () => {
            saveHistory([]);
        };

        // æ”¶è—ç®¡ç†
        const BOOKMARKS_KEY = 'news_bookmarks';
        const MAX_BOOKMARKS = 20;

        const getBookmarks = () => {
            try {
                return JSON.parse(localStorage.getItem(BOOKMARKS_KEY) || '[]');
            } catch {
                return [];
            }
        };

        const saveBookmarks = (bm) => {
            localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bm.slice(0, MAX_BOOKMARKS)));
        };

        const isBookmarked = (slug) => {
            const bm = getBookmarks();
            return bm.some(b => b.slug === slug);
        };

        const toggleBookmark = (article) => {
            if (!article || !article.slug) return;
            const bm = getBookmarks();
            const index = bm.findIndex(b => b.slug === article.slug);

            if (index > -1) {
                // å·²æ”¶è—ï¼Œå–æ¶ˆæ”¶è—
                bm.splice(index, 1);
                saveBookmarks(bm);
                bookmarks.value = getBookmarks();
                addToast('å·²å–æ¶ˆæ”¶è—', 'æ–‡ç« å·²ä»æ”¶è—å¤¹ç§»é™¤', 'info');
            } else {
                // æœªæ”¶è—ï¼Œæ·»åŠ æ”¶è—
                bm.unshift({
                    slug: article.slug,
                    title: article.title,
                    category: article.category_name,
                    bookmarked_at: new Date().toISOString()
                });
                saveBookmarks(bm);
                bookmarks.value = getBookmarks();
                addToast('æ”¶è—æˆåŠŸ', 'æ–‡ç« å·²æ·»åŠ åˆ°æ”¶è—å¤¹', 'success');
            }
        };

        const clearBookmarks = () => {
            if (confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰æ”¶è—å—ï¼Ÿ')) {
                saveBookmarks([]);
                bookmarks.value = getBookmarks();
            }
        };

        const fetchCategories = async () => {
            try {
                const r = await api.get('/categories');
                categories.value = r.data.categories;
            } catch (e) {}
        };

        const fetchStats = async () => {
            try {
                const r = await api.get('/admin/dashboard');
                stats.value = r.data.stats;
                recentArticles.value = r.data.recent_articles;
            } catch (e) {}
        };

        const fetchPopularArticles = async () => {
            try {
                const r = await api.get('/articles/popular');
                popularArticles.value = r.data.articles || [];
            } catch (e) {
                console.error('è·å–çƒ­é—¨æ–‡ç« å¤±è´¥:', e);
            }
        };

        const fetchAdminData = async () => {
            try {
                const [articlesRes, usersRes] = await Promise.all([
                    api.get('/articles', { status: null, per_page: 100 }),
                    api.get('/admin/users')
                ]);
                allArticles.value = articlesRes.data.articles;
                users.value = usersRes.data.users;
            } catch (e) {}
        };

        // æ“ä½œ
        const filterByCategory = (catId) => {
            selectedCategory.value = catId;
            fetchArticles(1);
        };

        const handleSearch = () => {
            fetchArticles(1);
        };

        const clearSearch = () => {
            searchQuery.value = '';
            fetchArticles(1);
        };

        const goToPage = (page) => {
            navigateTo(page === 1 ? '/' : '/page/' + page);
        };

        const handleLogin = async () => {
            error.value = '';
            submitting.value = true;
            try {
                const r = await api.post('/auth/login', loginForm.value);
                localStorage.setItem('refresh_token', r.data.refresh_token);
                authState.setUser(r.data.user, r.data.access_token);
                navigateTo('/');
            } catch (e) {
                error.value = e.message;
            } finally {
                submitting.value = false;
            }
        };

        const handleRegister = async () => {
            error.value = '';
            submitting.value = true;
            try {
                const r = await api.post('/auth/register', registerForm.value);
                localStorage.setItem('refresh_token', r.data.refresh_token);
                authState.setUser(r.data.user, r.data.access_token);
                navigateTo('/');
            } catch (e) {
                error.value = e.message;
            } finally {
                submitting.value = false;
            }
        };

        const logout = async () => {
            try { await api.post('/auth/logout'); } catch (e) {}
            authState.logout();
            navigateTo('/');
        };

        const editArticle = (art) => {
            editingArticle.value = art;
            articleForm.value = {
                title: art.title,
                content: art.content,
                category_id: art.category_id,
                status: art.status
            };
            showEditor.value = true;
        };

        const saveArticle = async () => {
            submitting.value = true;
            try {
                if (editingArticle.value) {
                    await api.put('/articles/' + editingArticle.value.slug, articleForm.value);
                } else {
                    await api.post('/articles', articleForm.value);
                }
                showEditor.value = false;
                editingArticle.value = null;
                articleForm.value = { title: '', content: '', category_id: null, status: 'draft' };
                await fetchAdminData();
                await fetchStats();
                await fetchArticles(currentPageNum.value);
                successMessage.value = 'ä¿å­˜æˆåŠŸ';
            } catch (e) {
                error.value = e.message;
            } finally {
                submitting.value = false;
            }
        };

        const publishArticle = async (art) => {
            try {
                await api.post('/articles/' + art.slug + '/publish');
                await fetchAdminData();
                await fetchStats();
            } catch (e) {
                error.value = e.message;
            }
        };

        const unpublishArticle = async (art) => {
            try {
                await api.post('/articles/' + art.slug + '/unpublish');
                await fetchAdminData();
                await fetchStats();
            } catch (e) {
                error.value = e.message;
            }
        };

        const deleteArticle = async (art) => {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')) return;
            try {
                await api.delete('/articles/' + art.slug);
                await fetchAdminData();
                await fetchStats();
                await fetchArticles(currentPageNum.value);
            } catch (e) {
                error.value = e.message;
            }
        };

        const editCategory = (cat) => {
            editingCategory.value = cat;
            categoryForm.value = { ...cat };
            showCategoryForm.value = true;
        };

        const saveCategory = async () => {
            try {
                if (editingCategory.value) {
                    await api.put('/categories/' + editingCategory.value.id, categoryForm.value);
                } else {
                    await api.post('/categories', categoryForm.value);
                }
                showCategoryForm.value = false;
                editingCategory.value = null;
                categoryForm.value = { name: '', slug: '', description: '' };
                await fetchCategories();
            } catch (e) {
                error.value = e.message;
            }
        };

        const deleteCategory = async (cat) => {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»å—ï¼Ÿ')) return;
            try {
                await api.delete('/categories/' + cat.id);
                await fetchCategories();
            } catch (e) {
                error.value = e.message;
            }
        };

        const toggleUser = async (userItem) => {
            try {
                await api.post('/admin/users/' + userItem.id + '/toggle-active');
                await fetchAdminData();
            } catch (e) {
                error.value = e.message;
            }
        };

        // Toast é€šçŸ¥ç³»ç»Ÿ
        const addToast = (title, message, type = 'info', duration = 4000) => {
            const id = Date.now();
            toasts.value.push({ id, title, message, type });
            if (duration > 0) {
                setTimeout(() => removeToast(id), duration);
            }
        };

        const removeToast = (id) => {
            const index = toasts.value.findIndex(t => t.id === id);
            if (index > -1) toasts.value.splice(index, 1);
        };

        // é˜…è¯»æ—¶é—´è®¡ç®—
        const calculateReadTime = (content) => {
            if (!content) return '1åˆ†é’Ÿ';
            const wordsPerMinute = 200;
            const words = content.replace(/<[^>]*>/g, '').replace(/[#*`]/g, '').length;
            const minutes = Math.max(1, Math.ceil(words / (wordsPerMinute / 2)));
            return minutes + 'åˆ†é’Ÿé˜…è¯»';
        };

        // æœç´¢å»ºè®®
        let searchTimeout = null;
        const handleSearchInput = () => {
            if (searchTimeout) clearTimeout(searchTimeout);
            if (searchQuery.value.length < 2) {
                searchSuggestions.value = [];
                showSearchSuggestions.value = false;
                return;
            }
            searchTimeout = setTimeout(async () => {
                try {
                    const r = await api.get('/articles', { search: searchQuery.value, per_page: 5 });
                    searchSuggestions.value = r.data.articles || [];
                    showSearchSuggestions.value = searchSuggestions.value.length > 0;
                } catch (e) {
                    searchSuggestions.value = [];
                }
            }, 300);
        };

        const selectSuggestion = (suggestion) => {
            searchQuery.value = suggestion.title;
            showSearchSuggestions.value = false;
            navigateTo('/article/' + suggestion.slug);
        };

        // ç›®å½•ç”Ÿæˆ
        const generateToc = () => {
            if (!articleContent.value) return;
            const headings = articleContent.value.querySelectorAll('h2, h3');
            tocItems.value = Array.from(headings).map((heading, index) => {
                const id = heading.id || 'heading-' + index;
                heading.id = id;
                return {
                    id,
                    text: heading.textContent,
                    level: parseInt(heading.tagName.charAt(1))
                };
            });
        };

        // é˜…è¯»è¿›åº¦
        const updateReadingProgress = () => {
            if (currentPage.value !== 'article') return;
            const scrollTop = window.scrollY || document.documentElement.scrollTop;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const progress = (scrollTop / docHeight) * 100;
            readingProgress.value = Math.min(100, Math.max(0, progress));
        };

        // é«˜äº®å½“å‰ç›®å½•
        const updateActiveToc = () => {
            const headings = document.querySelectorAll('.article-content h2, .article-content h3');
            for (let i = headings.length - 1; i >= 0; i--) {
                const rect = headings[i].getBoundingClientRect();
                if (rect.top < 150) {
                    activeToc.value = headings[i].id;
                    break;
                }
            }
        };

        // æ»šåŠ¨åˆ°æŒ‡å®šæ ‡é¢˜
        const scrollToHeading = (id) => {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        // å›åˆ°é¡¶éƒ¨
        const scrollToTop = () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // æ»šåŠ¨åˆ°æœç´¢æ¡†
        const scrollToSearch = () => {
            const searchBox = document.querySelector('.search-box');
            if (searchBox) {
                searchBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                searchBox.querySelector('input').focus();
            }
        };

        // åˆ†äº«åŠŸèƒ½
        const shareArticle = (platform) => {
            const url = window.location.href;
            const title = article.value?.title || document.title;
            const shareData = { url, title };

            if (platform === 'link') {
                navigator.clipboard.writeText(url).then(() => {
                    addToast('é“¾æ¥å·²å¤åˆ¶', 'æ–‡ç« é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                });
            } else if (platform === 'wechat') {
                addToast('åˆ†äº«åˆ°å¾®ä¿¡', 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æé¡µé¢ä¸Šçš„äºŒç»´ç æˆ–å¤åˆ¶é“¾æ¥åˆ†äº«', 'info');
            } else if (platform === 'weibo') {
                const weiboUrl = `https://service.weibo.com/share/share.php?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
                window.open(weiboUrl, '_blank');
            } else if (platform === 'twitter') {
                const twitterUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
                window.open(twitterUrl, '_blank');
            }
        };

        // æ–°é—»é€šè®¯è®¢é˜…
        const subscribeNewsletter = async () => {
            if (!newsletterEmail.value || !newsletterEmail.value.includes('@')) {
                newsletterMessage.value = { type: 'error', text: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' };
                return;
            }
            newsletterSubmitting.value = true;
            newsletterMessage.value = null;

            // æ¨¡æ‹Ÿè®¢é˜…è¯·æ±‚ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è°ƒç”¨åç«¯ APIï¼‰
            setTimeout(() => {
                newsletterSubmitting.value = false;
                newsletterMessage.value = { type: 'success', text: 'è®¢é˜…æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å…³æ³¨' };
                newsletterEmail.value = '';

                // 4ç§’åæ¸…é™¤æ¶ˆæ¯
                setTimeout(() => {
                    newsletterMessage.value = null;
                }, 4000);
            }, 1000);
        };

        // è®¾ç½®æ»šåŠ¨ç›‘å¬
        Vue.onMounted(async () => {
            const token = localStorage.getItem('access_token');
            if (token) {
                try {
                    const r = await api.get('/auth/me');
                    authState.setUser(r.data.user, token);
                } catch (e) {
                    authState.logout();
                }
            }
            await Promise.all([fetchCategories(), fetchStats(), fetchPopularArticles()]);
            handleRouteChange();
            window.addEventListener('popstate', handleRouteChange);
            window.addEventListener('scroll', updateReadingProgress);
            window.addEventListener('scroll', updateActiveToc);

            // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢å»ºè®®
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-box')) {
                    showSearchSuggestions.value = false;
                }
            });

            // æ–‡ç« é¡µé¢åŠ è½½åç”Ÿæˆç›®å½•
            if (currentPage.value === 'article') {
                setTimeout(generateToc, 500);
            }

            // é”®ç›˜å¯¼èˆª
            document.addEventListener('keydown', (e) => {
                // é¿å…åœ¨è¾“å…¥æ¡†ä¸­è§¦å‘
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }

                // Escape: è¿”å›é¦–é¡µ
                if (e.key === 'Escape') {
                    if (currentPage.value === 'article') {
                        navigateTo('/');
                    }
                }

                // /: èšç„¦æœç´¢æ¡†
                if (e.key === '/' && !searchQuery.value) {
                    e.preventDefault();
                    const searchInput = document.querySelector('.search-box input');
                    if (searchInput) searchInput.focus();
                }

                // Home: è¿”å›é¡¶éƒ¨
                if (e.key === 'Home') {
                    e.preventDefault();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                // End: æ»šåŠ¨åˆ°åº•éƒ¨
                if (e.key === 'End') {
                    e.preventDefault();
                    window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
                }
            });

            // æ»šåŠ¨è§¦å‘åŠ¨ç”»è§‚å¯Ÿå™¨
            initScrollAnimations();
        });

        // æ»šåŠ¨åŠ¨ç”»åˆå§‹åŒ–
        const initScrollAnimations = () => {
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                });

                document.querySelectorAll('.fade-in-section').forEach(el => {
                    observer.observe(el);
                });
            } else {
                // é™çº§å¤„ç†ï¼šç›´æ¥æ˜¾ç¤ºæ‰€æœ‰å…ƒç´ 
                document.querySelectorAll('.fade-in-section').forEach(el => {
                    el.classList.add('is-visible');
                });
            }
        };

        // å›¾ç‰‡æ‡’åŠ è½½
        const initLazyImages = () => {
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.onload = () => img.classList.add('loaded');
                                img.removeAttribute('data-src');
                            }
                            observer.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '50px 0px'
                });

                document.querySelectorAll('img[data-src]').forEach(img => {
                    observer.observe(img);
                });
            } else {
                // é™çº§å¤„ç†ï¼šç«‹å³åŠ è½½æ‰€æœ‰å›¾ç‰‡
                document.querySelectorAll('img[data-src]').forEach(img => {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    img.classList.add('loaded');
                });
            }
        };

        // æ—¥æœŸæ ¼å¼åŒ–
        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('zh-CN');
        };

        const formatFullDate = (dateStr) => {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleString('zh-CN');
        };

        const formatShortDate = (dateStr) => {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        };

        return {
            currentPage, articles, article, categories, allArticles, users, recentArticles, stats,
            totalPages, currentPageNum, selectedCategory, error, successMessage, loading, submitting,
            mobileMenuOpen, searchQuery, loginForm, registerForm, articleForm, categoryForm,
            showEditor, showCategoryForm, editingArticle, editingCategory, adminSection, showPreview, previewHtml,
            // æ–°å¢çŠ¶æ€
            toasts, readingProgress, searchSuggestions, showSearchSuggestions, readingHistory, bookmarks, tocItems, activeToc, articleContent, isDarkMode, popularArticles,
            newsletterEmail, newsletterSubmitting, newsletterMessage,
            // è®¡ç®—å±æ€§
            isLoggedIn: Vue.computed(() => authState.isLoggedIn),
            isAdmin: Vue.computed(() => authState.isAdmin),
            user: Vue.computed(() => authState.user),
            // æ–¹æ³•
            filterByCategory, handleSearch, clearSearch, goToPage, handleLogin, handleRegister, logout,
            editArticle, saveArticle, publishArticle, unpublishArticle, deleteArticle,
            editCategory, saveCategory, deleteCategory, toggleUser,
            formatDate, formatFullDate, formatShortDate,
            // æ–°å¢æ–¹æ³•
            calculateReadTime, handleSearchInput, selectSuggestion, scrollToHeading,
            scrollToTop, scrollToSearch, shareArticle, removeToast, addToast,
            getHistory, addToHistory, clearHistory,
            getBookmarks, isBookmarked, toggleBookmark, clearBookmarks, toggleTheme,
            subscribeNewsletter
        };
    }
});

// Auto-mount on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        app.mount('#app');
    });
} else {
    app.mount('#app');
}
</script>
</body>
</html>
